class SyncManager{constructor(app){this.app=app;this.syncInProgress=false;}async syncWithMainSite(){if(this.syncInProgress){console.log('Sync already in progress...');return;}this.syncInProgress=true;console.log('🔄 Starting sync with main site...');try{await this.updateMainSiteData();await this.generateVillaDetailsData();await this.generateIndexData();this.app.showToast('✅ Synchronisation avec le site principal réussie','success');console.log('✅ Sync completed successfully');}catch(error){console.error('❌ Sync error:',error);this.app.showToast('❌ Erreur de synchronisation: '+error.message,'error');}finally{this.syncInProgress=false;}}updateMainSiteData(){return new Promise((resolve)=>{const mainSiteVillas=this.app.villas .filter(villa=> villa.status==='active').map(villa=>({id: villa.id,name: villa.name,location: villa.location,price: villa.price+'€/nuit',guests: villa.capacity+' personnes',image: villa.photos && villa.photos[0] ? villa.photos[0] : './images/placeholder.jpg',gallery: villa.photos || [],description: villa.description,amenities: this.formatAmenitiesForMainSite(villa.amenities || [])}));localStorage.setItem('main_site_sync_data',JSON.stringify({villas: mainSiteVillas,lastSync: new Date().toISOString(),adminVersion: '1.0'}));console.log(`📊 Updated main site data: ${mainSiteVillas.length}active villas`);resolve();});}generateVillaDetailsData(){return new Promise((resolve)=>{const villaDetailsData={};this.app.villas .filter(villa=> villa.status==='active').forEach(villa=>{villaDetailsData[villa.id]={name: villa.name,location: "📍 "+villa.location,price: villa.price+"€/nuit",guests: "👥 "+villa.capacity+" personnes",image: villa.photos && villa.photos[0] ? villa.photos[0] : "./images/placeholder.jpg",gallery: villa.photos || [],description: villa.description,amenities: this.formatAmenitiesForVillaDetails(villa.amenities || [])};});localStorage.setItem('villa_details_data',JSON.stringify(villaDetailsData));console.log(`🏠 Generated villa-details data for ${Object.keys(villaDetailsData).length}villas`);resolve();});}generateIndexData(){return new Promise((resolve)=>{const indexData=this.app.villas .filter(villa=> villa.status==='active').map(villa=>({id: villa.id,name: villa.name,price: villa.price,guests: villa.capacity+" personnes",guestsDetail: `${villa.capacity}personnes+invités`,features:(villa.amenities || []).join(','),category: villa.capacity > 15 ? 'fete' : 'sejour',image: villa.photos && villa.photos[0] ? villa.photos[0] : "./images/placeholder.jpg",gallery: villa.photos || [],fallbackIcon: this.getVillaIcon(villa),location: villa.location}));localStorage.setItem('index_villas_data',JSON.stringify(indexData));console.log(`📝 Generated index data for ${indexData.length}villas`);resolve();});}formatAmenitiesForMainSite(amenities){const iconMap={'piscine': '🏊','wifi': '📶','climatisation': '❄️','vue-mer': '🌊','parking': '🚗','cuisine': '🍳','terrasse': '🏖️','barbecue': '🔥','jacuzzi': '🛁','plage': '🏖️','jardin': '🌳','tv': '📺','sauna': '🧖‍♀️'};return amenities.map(amenity=>({icon: iconMap[amenity] || '✨',name: this.capitalizeFirst(amenity.replace('-',' '))}));}formatAmenitiesForVillaDetails(amenities){return this.formatAmenitiesForMainSite(amenities);}getVillaIcon(villa){if(villa.amenities){if(villa.amenities.includes('piscine'))return '🏊';if(villa.amenities.includes('vue-mer'))return '🌊';if(villa.amenities.includes('jacuzzi'))return '🛁';if(villa.amenities.includes('plage'))return '🏖️';}return '🏠';}capitalizeFirst(str){return str.charAt(0).toUpperCase()+str.slice(1);}triggerRealTimeSync(){clearTimeout(this.syncTimeout);this.syncTimeout=setTimeout(()=>{this.syncWithMainSite();},1000);}exportMainSiteUpdate(){const syncData=localStorage.getItem('main_site_sync_data');if(!syncData){this.app.showToast('❌ Aucune donnée à exporter','error');return;}const updateData={villaDetailsData: JSON.parse(localStorage.getItem('villa_details_data')|| '{}'),indexVillasData: JSON.parse(localStorage.getItem('index_villas_data')|| '[]'),syncInfo: JSON.parse(syncData),updateInstructions:{villaDetails: 'Replace the villas object in villa-details.html with villaDetailsData',indexPage: 'Replace the villasData array in index.html with indexVillasData',timestamp: new Date().toISOString()}};const blob=new Blob([JSON.stringify(updateData,null,2)],{type: 'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`khanelconcept-site-update-${new Date().toISOString().split('T')[0]}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);this.app.showToast('📥 Mise à jour du site principal exportée','success');}showLivePreview(villaId){const previewUrl=`../villa-details.html?id=${villaId}&preview=admin`;const previewWindow=window.open(previewUrl,'_blank');if(previewWindow){previewWindow.addEventListener('load',()=>{const villaData=JSON.parse(localStorage.getItem('villa_details_data')|| '{}');previewWindow.postMessage({type: 'ADMIN_PREVIEW_DATA',data: villaData},'*');});}}}if(typeof window !=='undefined' && window.app){window.app.syncManager=new SyncManager(window.app);const originalSaveData=window.app.saveData;window.app.saveData=function(){originalSaveData.call(this);if(this.syncManager){this.syncManager.triggerRealTimeSync();}};}function exportSiteUpdate(){if(window.app && window.app.syncManager){window.app.syncManager.exportMainSiteUpdate();}}function previewVilla(villaId){if(window.app && window.app.syncManager){window.app.syncManager.showLivePreview(villaId);}}