
// PROTECTION IMAGES/VIDÉOS - NE PAS SUPPRIMER
function protectMediaElements() {
    const mediaElements = document.querySelectorAll('img, video');
    mediaElements.forEach(element => {
        element.setAttribute('data-protected', 'true');
    });
}

// Protéger avant toute modification DOM
if (typeof MutationObserver !== 'undefined') {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                // Vérifier que les éléments média ne sont pas supprimés
                mutation.removedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && (node.tagName === 'IMG' || node.tagName === 'VIDEO')) {
                        console.warn('⚠️ Tentative de suppression d\'élément média détectée:', node);
                    }
                });
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
}


class VillaManager{constructor(app){this.app=app;this.currentVilla=null;this.setupVillaModal();}setupVillaModal(){const modalElement=document.getElementById('villaModal');if(modalElement){modalElement.addEventListener('hidden.bs.modal',()=>{this.resetVillaForm();this.currentVilla=null;});}}showAddVillaModal(){this.currentVilla=null;this.resetVillaForm();document.getElementById('villaModalTitle').textContent='Ajouter Villa';const modal=new bootstrap.Modal(document.getElementById('villaModal'));modal.show();}editVilla(villaId){const villa=this.app.villas.find(v=> v.id===villaId);if(!villa){this.app.showToast('Villa non trouvée','error');return;}this.currentVilla=villa;this.populateVillaForm(villa);document.getElementById('villaModalTitle').textContent='Éditer Villa';const modal=new bootstrap.Modal(document.getElementById('villaModal'));modal.show();}duplicateVilla(villaId){const villa=this.app.villas.find(v=> v.id===villaId);if(!villa){this.app.showToast('Villa non trouvée','error');return;}const duplicatedVilla={...villa,id: this.generateVillaId(),name: villa.name+'(Copie)',created: new Date().toISOString(),updated: new Date().toISOString()};this.app.villas.push(duplicatedVilla);this.app.saveData();this.app.loadVillasGrid();this.app.updateDashboard();this.app.showToast('Villa dupliquée avec succès','success');}deleteVilla(villaId){const villa=this.app.villas.find(v=> v.id===villaId);if(!villa){this.app.showToast('Villa non trouvée','error');return;}if(confirm(`Êtes-vous sûr de vouloir supprimer "${villa.name}" ? Cette action est irréversible.`)){this.app.villas=this.app.villas.filter(v=> v.id !==villaId);this.app.saveData();this.app.loadVillasGrid();this.app.updateDashboard();this.app.showToast('Villa supprimée avec succès','success');}}populateVillaForm(villa){document.getElementById('villaName').value=villa.name;document.getElementById('villaPrice').value=villa.price;document.getElementById('villaCapacity').value=villa.capacity;document.getElementById('villaBedrooms').value=villa.bedrooms || '';document.getElementById('villaBathrooms').value=villa.bathrooms || '';document.getElementById('villaLocation').value=villa.location;document.getElementById('villaGPS').value=villa.gps || '';document.getElementById('villaHighSeasonPrice').value=villa.highSeasonPrice || '';document.getElementById('villaLowSeasonPrice').value=villa.lowSeasonPrice || '';document.getElementById('villaStatus').value=villa.status;document.getElementById('villaDescription').value=villa.description;document.getElementById('villaCancellationPolicy').value=villa.cancellationPolicy || '';document.getElementById('villaHouseRules').value=villa.houseRules || '';this.clearAmenities();if(villa.amenities && villa.amenities.length > 0){villa.amenities.forEach(amenity=>{const checkbox=document.getElementById(`amenity-${amenity}`);if(checkbox){checkbox.checked=true;}});}}resetVillaForm(){document.getElementById('villaForm').reset();this.clearAmenities();}clearAmenities(){document.querySelectorAll('[id^="amenity-"]').forEach(checkbox=>{checkbox.checked=false;});}saveVilla(){const formData=this.validateVillaForm();if(!formData){return;}if(this.currentVilla){const index=this.app.villas.findIndex(v=> v.id===this.currentVilla.id);if(index !==-1){this.app.villas[index]={...this.currentVilla,...formData,updated: new Date().toISOString()};this.app.showToast('Villa modifiée avec succès','success');}}else{const newVilla={id: this.generateVillaId(),...formData,created: new Date().toISOString(),updated: new Date().toISOString()};this.app.villas.push(newVilla);this.app.showToast('Villa ajoutée avec succès','success');}this.app.saveData();this.app.loadVillasGrid();this.app.updateDashboard();const modal=bootstrap.Modal.getInstance(document.getElementById('villaModal'));modal.hide();}validateVillaForm(){const requiredFields=[{id: 'villaName',name: 'Nom'},{id: 'villaPrice',name: 'Prix'},{id: 'villaCapacity',name: 'Capacité'},{id: 'villaLocation',name: 'Localisation'},{id: 'villaDescription',name: 'Description'}];for(const field of requiredFields){const element=document.getElementById(field.id);const value=element.value.trim();if(!value){this.app.showToast(`Le champ "${field.name}" est obligatoire`,'error');element.focus();return null;}}const price=parseFloat(document.getElementById('villaPrice').value);const capacity=parseInt(document.getElementById('villaCapacity').value);if(isNaN(price)|| price <=0){this.app.showToast('Le prix doit être un nombre positif','error');return null;}if(isNaN(capacity)|| capacity <=0){this.app.showToast('La capacité doit être un nombre positif','error');return null;}const formData={name: document.getElementById('villaName').value.trim(),price: price,capacity: capacity,bedrooms: parseInt(document.getElementById('villaBedrooms').value)|| 0,bathrooms: parseInt(document.getElementById('villaBathrooms').value)|| 0,location: document.getElementById('villaLocation').value.trim(),gps: document.getElementById('villaGPS').value.trim(),description: document.getElementById('villaDescription').value.trim(),status: document.getElementById('villaStatus').value,highSeasonPrice: parseFloat(document.getElementById('villaHighSeasonPrice').value)|| null,lowSeasonPrice: parseFloat(document.getElementById('villaLowSeasonPrice').value)|| null,cancellationPolicy: document.getElementById('villaCancellationPolicy').value.trim(),houseRules: document.getElementById('villaHouseRules').value.trim(),amenities: this.getSelectedAmenities(),photos: this.currentVilla?.photos || []};return formData;}getSelectedAmenities(){const amenities=[];const checkboxes=document.querySelectorAll('[id^="amenity-"]:checked');checkboxes.forEach(checkbox=>{const amenity=checkbox.id.replace('amenity-','');amenities.push(amenity);});return amenities;}generateVillaId(){const maxId=this.app.villas.reduce((max,villa)=> Math.max(max,villa.id),0);return maxId+1;}importFromMainSite(){const mainSiteVillas=this.getMainSiteVillas();if(confirm(`Importer ${mainSiteVillas.length}villas depuis le site principal ? Cela ajoutera les villas manquantes.`)){let importedCount=0;mainSiteVillas.forEach(mainVilla=>{const exists=this.app.villas.find(v=> v.name.toLowerCase()===mainVilla.name.toLowerCase());if(!exists){const newVilla={id: this.generateVillaId(),...mainVilla,created: new Date().toISOString(),updated: new Date().toISOString()};this.app.villas.push(newVilla);importedCount++;}});if(importedCount > 0){this.app.saveData();this.app.loadVillasGrid();this.app.updateDashboard();this.app.showToast(`${importedCount}villas importées avec succès`,'success');}else{this.app.showToast('Aucune nouvelle villa à importer','info');}}}getMainSiteVillas(){return [{name: "Villa F3 Petit Macabou",description: "Magnifique villa F3 avec sauna et jacuzzi,parfaite pour un séjour de détente en famille.",price: 850,capacity: 6,bedrooms: 2,bathrooms: 2,location: "Petit Macabou au Vauclin",amenities: ["piscine","sauna","jacuzzi","wifi"],photos: ["images/Villa_F3_Petit_Macabou/01_piscine_exterieur.jpg"],status: "active"},{name: "Villa F5 Ste Anne",description: "Villa F5 distinctive avec sa façade rose emblématique.",price: 1300,capacity: 10,bedrooms: 3,bathrooms: 2,location: "Quartier Les Anglais,Ste Anne",amenities: ["piscine","wifi","cuisine","parking"],photos: ["images/Villa_F5_Ste_Anne/01_piscine_principale.jpg"],status: "active"}];}bulkUpdateStatus(villaIds,newStatus){let updatedCount=0;villaIds.forEach(id=>{const villa=this.app.villas.find(v=> v.id===id);if(villa && villa.status !==newStatus){villa.status=newStatus;villa.updated=new Date().toISOString();updatedCount++;}});if(updatedCount > 0){this.app.saveData();this.app.loadVillasGrid();this.app.updateDashboard();this.app.showToast(`${updatedCount}villas mises à jour`,'success');}}bulkDelete(villaIds){if(confirm(`Supprimer ${villaIds.length}villas ? Cette action est irréversible.`)){this.app.villas=this.app.villas.filter(v=> !villaIds.includes(v.id));this.app.saveData();this.app.loadVillasGrid();this.app.updateDashboard();this.app.showToast(`${villaIds.length}villas supprimées`,'success');}}}function showAddVillaModal(){if(window.app && window.app.villaManager){window.app.villaManager.showAddVillaModal();}}function saveVilla(){if(window.app && window.app.villaManager){window.app.villaManager.saveVilla();}}