const sqlite3=require('sqlite3').verbose();const bcrypt=require('bcryptjs');const path=require('path');const fs=require('fs').promises;const{v4: uuidv4}=require('uuid');const DB_PATH=path.join(__dirname,'../admin_proprietaires.db');const CSV_PATH=path.join(__dirname,'../../Catalogue_Villas_Khanel_Concept_Complet_Final.csv');const VILLAS_DATA=[{name: 'Villa F3 sur Petit Macabou',location: 'Petit Macabou,Vauclin',capacity: 6,bedrooms: 3,bathrooms: 2,surface: 140,default_price: 1550,description: 'Villa F3 moderne au Petit Macabou avec possibilit√© journ√©e',image: '/ALLINCLUSIVE2.0/images/Villa_F3_Petit_Macabou/01_piscine_exterieur.jpg'},{name: 'Villa F3 POUR LA BACCHA',location: 'Petit Macabou',capacity: 6,bedrooms: 2,bathrooms: 1,surface: 120,default_price: 750,description: 'Villa F3 √† la Baccha avec invit√©s journ√©e',image: '/ALLINCLUSIVE2.0/images/Villa_F3_Baccha_Petit_Macabou/01_terrasse_piscine_salon_ext.jpg'},{name: 'Villa F3 sur le Fran√ßois',location: 'Hauteurs du Morne Carri√®re au Fran√ßois',capacity: 4,bedrooms: 2,bathrooms: 1,surface: 110,default_price: 800,description: 'Villa F3 panoramique au Fran√ßois',image: '/ALLINCLUSIVE2.0/images/Villa_F3_Le_Francois/01_terrasse_panoramique_vue_mer.jpg'},{name: 'Villa F5 sur Ste Anne',location: 'Quartier les Anglais,Ste Anne',capacity: 10,bedrooms: 4,bathrooms: 4,surface: 200,default_price: 1350,description: 'Villa F5 spacieuse √† Ste Anne avec invit√©s journ√©e',image: '/ALLINCLUSIVE2.0/images/Villa_F5_Ste_Anne/01_piscine_principale.jpg'},{name: 'Villa F6 au Lamentin',location: 'Quartier B√©leme,Lamentin',capacity: 12,bedrooms: 5,bathrooms: 4,surface: 250,default_price: 1200,description: 'Villa F6 avec piscine et jacuzzi au Lamentin',image: '/ALLINCLUSIVE2.0/images/Villa_F6_Lamentin/01_piscine_jacuzzi_vue_ensemble.jpg'},{name: 'Villa F6 sur Ste Luce √† 1mn de la plage',location: 'Zac de Pont Caf√©,Ste Luce',capacity: 14,bedrooms: 5,bathrooms: 5,surface: 280,default_price: 1800,description: 'Villa F6 complexe pr√®s de la plage Corps de garde',image: '/ALLINCLUSIVE2.0/images/Villa_F6_Ste_Luce_Plage/02_chambre_poutres.jpg'},{name: 'Villa F7 Baie des Mulets',location: 'Baie des Mulets,Vauclin',capacity: 16,bedrooms: 7,bathrooms: 6,surface: 350,default_price: 2200,description: 'Villa F7 exceptionnelle(F5+F3)√† Baie des Mulets',image: '/ALLINCLUSIVE2.0/images/Villa_F7_Baie_des_Mulets_Vauclin/01_chambre_climatisee.jpg'},{name: 'Villa F3 Bas de villa Trinit√© Cosmy',location: 'Cosmy,Trinit√©',capacity: 5,bedrooms: 2,bathrooms: 1,surface: 100,default_price: 500,description: 'Bas de villa charmant avec piscine chauff√©e',image: '/ALLINCLUSIVE2.0/images/Villa_F3_Trinite_Cosmy/01_piscine_chauffee_vue_collines.jpg'},{name: 'Bas de villa F3 sur le Robert',location: 'Pointe Hyacinthe,Le Robert',capacity: 10,bedrooms: 2,bathrooms: 1,surface: 120,default_price: 900,description: 'Villa moderne avec terrasses panoramiques au Robert',image: '/ALLINCLUSIVE2.0/images/Villa_F3_Robert_Pointe_Hyacinthe/01_piscine_rectangulaire.jpg'},{name: 'Villa F5 Vauclin Ravine Plate',location: 'Hauteurs de Ravine Plate,Vauclin',capacity: 8,bedrooms: 4,bathrooms: 4,surface: 180,default_price: 1550,description: 'Villa F5 avec piscine √† d√©bordement panoramique',image: '/ALLINCLUSIVE2.0/images/Villa_F5_Vauclin_Ravine_Plate/01_piscine_debordement_vue_panoramique.jpg'},{name: 'Villa F5 La Ren√©e',location: 'Quartier La Ren√©e,Rivi√®re-Pilote',capacity: 10,bedrooms: 4,bathrooms: 2,surface: 170,default_price: 900,description: 'Villa F5 avec jacuzzi et grande terrasse',image: '/ALLINCLUSIVE2.0/images/Villa_F5_R_Pilote_La_Renee/01_terrasse_bois_piscine_palmiers.jpg'},{name: 'Bas de villa F3 sur Ste Luce',location: 'Sainte-Luce',capacity: 6,bedrooms: 2,bathrooms: 1,surface: 90,default_price: 570,description: 'Bas de villa cosy √† Sainte-Luce',image: '/ALLINCLUSIVE2.0/images/Bas_Villa_F3_Ste_Luce/01_eclairage_led_terrasse_lounge.jpg'},{name: 'Studio Cocooning Lamentin',location: 'Hauteurs de Morne Pitault,Lamentin',capacity: 2,bedrooms: 1,bathrooms: 1,surface: 45,default_price: 290,description: 'Studio cocooning avec bac √† punch priv√©',image: '/ALLINCLUSIVE2.0/images/Studio_Cocooning_Lamentin/01_jacuzzi_terrasse_privee.jpg'},{name: 'Villa F6 sur Petit Macabou(s√©jour+f√™te)',location: 'Petit Macabou au Vauclin',capacity: 13,bedrooms: 6,bathrooms: 6,surface: 320,default_price: 2000,description: 'Villa F6 somptueuse avec possibilit√© √©v√©nements',image: '/ALLINCLUSIVE2.0/images/Villa_F6_Petit_Macabou/02_salle_de_bain.jpg'},{name: 'Appartement F3 Trenelle(Location Annuelle)',location: 'Trenelle,√† 2 minutes du PPM',capacity: 2,bedrooms: 2,bathrooms: 1,surface: 80,default_price: 700,description: 'Appartement F3 meubl√© pour location annuelle',image: '/ALLINCLUSIVE2.0/images/Villa_F3_Trenelle_Location_Annuelle/01_cuisine_equipee_evier_double.jpg'},{name: 'Villa F√™te Journ√©e Ducos',location: 'Ducos',capacity: 30,bedrooms: 0,bathrooms: 1,surface: 200,default_price: 375,description: 'Villa location √† la journ√©e avec piscine et espace ext√©rieur',image: '/ALLINCLUSIVE2.0/images/Villa_Fete_Journee_Ducos/01_piscine_espace_exterieur.jpg'},{name: 'Villa F√™te Journ√©e Fort de France',location: 'Fort de France',capacity: 80,bedrooms: 0,bathrooms: 2,surface: 300,default_price: 100,description: 'Villa √©v√©nementielle disponible de 6h √† minuit',image: '/ALLINCLUSIVE2.0/images/Villa_Fete_Journee_Fort_de_France/01_espace_reception.jpg'},{name: 'Villa F√™te Journ√©e Rivi√®re-Pilote',location: 'Rivi√®re-Pilote',capacity: 100,bedrooms: 1,bathrooms: 2,surface: 250,default_price: 660,description: 'Villa avec piscine chauff√©e et cuisine ext√©rieure √©quip√©e',image: '/ALLINCLUSIVE2.0/images/Villa_Fete_Journee_R_Pilote/01_piscine_chauffee_cuisine_ext.jpg'},{name: 'Villa F√™te Journ√©e Rivi√®re Sal√©e',location: 'Quartier La Laugier,Rivi√®re Sal√©e',capacity: 100,bedrooms: 0,bathrooms: 1,surface: 200,default_price: 400,description: 'Villa journ√©e avec 5 tables rectangulaires et chaises',image: '/ALLINCLUSIVE2.0/images/Villa_Fete_Journee_Riviere_Salee/01_espace_tables_reception.jpg'},{name: 'Villa F√™te Journ√©e Sainte-Luce',location: 'Sainte-Luce,pr√®s de la For√™t Montravail',capacity: 40,bedrooms: 0,bathrooms: 1,surface: 150,default_price: 390,description: 'Villa journ√©e avec 3 tentes,3 salons ext√©rieurs et syst√®me son JBL',image: '/ALLINCLUSIVE2.0/images/Villa_Fete_Journee_Sainte_Luce/01_tentes_salons_ext.jpg'},{name: 'Espace Piscine Journ√©e Bungalow',location: 'Martinique',capacity: 150,bedrooms: 1,bathrooms: 1,surface: 100,default_price: 350,description: 'Espace piscine journ√©e avec bungalow climatis√©',image: '/ALLINCLUSIVE2.0/images/Espace_Piscine_Journee_Bungalow/01_piscine_bungalow.jpg'}];class DatabaseInitializer{constructor(){this.db=null;}async init(){return new Promise((resolve,reject)=>{this.db=new sqlite3.Database(DB_PATH,(err)=>{if(err){console.error('Erreur connexion SQLite:',err);reject(err);}else{console.log('‚úÖ Connexion SQLite √©tablie pour initialisation');this.createTables().then(resolve).catch(reject);}});});}async createTables(){const queries=[ `CREATE TABLE IF NOT EXISTS villas(id TEXT PRIMARY KEY,code TEXT UNIQUE NOT NULL,name TEXT NOT NULL,location TEXT NOT NULL,capacity INTEGER,bedrooms INTEGER,bathrooms INTEGER,surface INTEGER,default_price REAL,description TEXT,image TEXT,owner_email TEXT,owner_password TEXT,is_active BOOLEAN DEFAULT 1,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,updated_at DATETIME DEFAULT CURRENT_TIMESTAMP)`,`CREATE TABLE IF NOT EXISTS access_codes(id TEXT PRIMARY KEY,code TEXT UNIQUE NOT NULL,villa_id TEXT NOT NULL,expires_at DATETIME NOT NULL,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,used_at DATETIME,is_active BOOLEAN DEFAULT 1,FOREIGN KEY(villa_id)REFERENCES villas(id))`,`CREATE TABLE IF NOT EXISTS availabilities(id TEXT PRIMARY KEY,villa_id TEXT NOT NULL,start_date DATE NOT NULL,end_date DATE NOT NULL,type TEXT NOT NULL CHECK(type IN('available','booked','blocked')),price_per_night REAL,reason TEXT,notes TEXT,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,FOREIGN KEY(villa_id)REFERENCES villas(id))`,`CREATE TABLE IF NOT EXISTS reservations(id TEXT PRIMARY KEY,villa_id TEXT NOT NULL,client_name TEXT,client_email TEXT,client_phone TEXT,checkin_date DATE NOT NULL,checkout_date DATE NOT NULL,total_amount REAL,status TEXT DEFAULT 'pending' CHECK(status IN('pending','confirmed','cancelled')),created_at DATETIME DEFAULT CURRENT_TIMESTAMP,FOREIGN KEY(villa_id)REFERENCES villas(id))` ];for(const query of queries){await this.run(query);}console.log('‚úÖ Tables cr√©√©es/v√©rifi√©es');}run(query,params=[]){return new Promise((resolve,reject)=>{this.db.run(query,params,function(err){if(err)reject(err);else resolve({id: this.lastID,changes: this.changes});});});}get(query,params=[]){return new Promise((resolve,reject)=>{this.db.get(query,params,(err,row)=>{if(err)reject(err);else resolve(row);});});}generateVillaCode(villaName){const words=villaName.split(' ').filter(word=> word.length > 2);let code='';words.slice(0,2).forEach(word=>{code+=word.substring(0,2).toUpperCase();});while(code.length < 6){code+=Math.floor(Math.random()*10);}return code.substring(0,6).replace(/[^A-Z0-9]/g,'');}async insertVillas(){console.log('üìù Insertion des villas...');for(let i=0;i < VILLAS_DATA.length;i++){const villa=VILLAS_DATA[i];const villaId=uuidv4();const villaCode=this.generateVillaCode(villa.name);let finalCode=villaCode;let attempts=0;while(attempts < 10){const existing=await this.get('SELECT id FROM villas WHERE code=?',[finalCode]);if(!existing)break;finalCode=villaCode.substring(0,4)+String(Math.floor(Math.random()*100)).padStart(2,'0');attempts++;}await this.run(` INSERT INTO villas(id,code,name,location,capacity,bedrooms,bathrooms,surface,default_price,description,image,is_active)VALUES(?,?,?,?,?,?,?,?,?,?,?,1)`,[ villaId,finalCode,villa.name,villa.location,villa.capacity,villa.bedrooms,villa.bathrooms,villa.surface,villa.default_price,villa.description,villa.image ]);const accessCodeId=uuidv4();const expiresAt=new Date();expiresAt.setFullYear(expiresAt.getFullYear()+1);await this.run(` INSERT INTO access_codes(id,code,villa_id,expires_at,is_active)VALUES(?,?,?,?,1)`,[accessCodeId,finalCode,villaId,expiresAt.toISOString()]);console.log(`‚úÖ Villa "${villa.name}" ajout√©e avec code: ${finalCode}`);}}async insertSampleReservations(){console.log('üìù Insertion de r√©servations d\'exemple...');const villas=await new Promise((resolve,reject)=>{this.db.all('SELECT id,name FROM villas LIMIT 5',[],(err,rows)=>{if(err)reject(err);else resolve(rows || []);});});if(!villas || villas.length===0){console.log('‚ö†Ô∏è Aucune villa trouv√©e pour les r√©servations');return;}const sampleReservations=[{client_name: 'Marie Dubois',client_email: 'marie.dubois@email.com',checkin_date: '2024-08-15',checkout_date: '2024-08-22',total_amount: 1500,status: 'confirmed'},{client_name: 'Pierre Martin',client_email: 'pierre.martin@email.com',checkin_date: '2024-09-01',checkout_date: '2024-09-08',total_amount: 2800,status: 'pending'},{client_name: 'Sophie Laurent',client_email: 'sophie.laurent@email.com',checkin_date: '2024-07-20',checkout_date: '2024-07-27',total_amount: 1200,status: 'confirmed'}];for(let i=0;i < Math.min(villas.length,3);i++){const villa=villas[i];const reservation=sampleReservations[i];await this.run(` INSERT INTO reservations(id,villa_id,client_name,client_email,checkin_date,checkout_date,total_amount,status)VALUES(?,?,?,?,?,?,?,?)`,[ uuidv4(),villa.id,reservation.client_name,reservation.client_email,reservation.checkin_date,reservation.checkout_date,reservation.total_amount,reservation.status ]);console.log(`‚úÖ R√©servation ajout√©e pour ${villa.name}`);}}async insertSampleAvailabilities(){console.log('üìù Insertion de disponibilit√©s d\'exemple...');const villas=await new Promise((resolve,reject)=>{this.db.all('SELECT id,name,default_price FROM villas',[],(err,rows)=>{if(err)reject(err);else resolve(rows || []);});});if(!villas || villas.length===0){console.log('‚ö†Ô∏è Aucune villa trouv√©e pour les disponibilit√©s');return;}for(let i=0;i < Math.min(villas.length,5);i++){const villa=villas[i];const availabilities=[{start_date: '2024-08-01',end_date: '2024-08-07',type: 'available',price_per_night: villa.default_price},{start_date: '2024-08-15',end_date: '2024-08-22',type: 'booked',price_per_night: villa.default_price},{start_date: '2024-09-01',end_date: '2024-09-03',type: 'blocked',reason: 'maintenance',notes: 'Maintenance piscine'}];for(const avail of availabilities){await this.run(` INSERT INTO availabilities(id,villa_id,start_date,end_date,type,price_per_night,reason,notes)VALUES(?,?,?,?,?,?,?,?)`,[ uuidv4(),villa.id,avail.start_date,avail.end_date,avail.type,avail.price_per_night,avail.reason,avail.notes ]);}console.log(`‚úÖ Disponibilit√©s ajout√©es pour ${villa.name}`);}}async close(){if(this.db){this.db.close();}}}async function main(){console.log('üöÄ==========================================');console.log('üè† INITIALISATION BASE DE DONN√âES ADMIN');console.log('üöÄ==========================================');const initializer=new DatabaseInitializer();try{await initializer.init();console.log('üìù Insertion des donn√©es...');await initializer.insertVillas();await initializer.insertSampleReservations();await initializer.insertSampleAvailabilities();console.log('üéâ==========================================');console.log('‚úÖ INITIALISATION TERMIN√âE AVEC SUCC√àS !');console.log('üéâ==========================================');console.log('üìä Statistiques:');console.log(` ‚Ä¢ ${VILLAS_DATA.length}villas ajout√©es`);console.log(` ‚Ä¢ ${VILLAS_DATA.length}codes d'acc√®s g√©n√©r√©s`);console.log(' ‚Ä¢ 3 r√©servations d\'exemple');console.log(' ‚Ä¢ 15 disponibilit√©s d\'exemple');console.log('');console.log('üîë CODES D\'ACC√àS G√âN√âR√âS:');const villas=await new Promise((resolve,reject)=>{initializer.db.all(` SELECT v.name,ac.code FROM villas v JOIN access_codes ac ON v.id=ac.villa_id ORDER BY v.name `,[],(err,rows)=>{if(err)reject(err);else resolve(rows);});});villas.forEach(villa=>{console.log(` ‚Ä¢ ${villa.name}: ${villa.code}`);});console.log('');console.log('üöÄ Vous pouvez maintenant d√©marrer le serveur avec:');console.log(' cd admin-backend && npm start');}catch(error){console.error('‚ùå Erreur lors de l\'initialisation:',error);process.exit(1);}finally{await initializer.close();}}main();