
// PROTECTION IMAGES/VIDÉOS - NE PAS SUPPRIMER
function protectMediaElements() {
    const mediaElements = document.querySelectorAll('img, video');
    mediaElements.forEach(element => {
        element.setAttribute('data-protected', 'true');
    });
}

// Protéger avant toute modification DOM
if (typeof MutationObserver !== 'undefined') {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                // Vérifier que les éléments média ne sont pas supprimés
                mutation.removedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && (node.tagName === 'IMG' || node.tagName === 'VIDEO')) {
                        console.warn('⚠️ Tentative de suppression d\'élément média détectée:', node);
                    }
                });
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
}


class ValidationEngine{constructor(){this.validators=new Map();this.fields=new Map();this.rules={required:{test:(value)=> value && value.trim().length > 0,message: 'Ce champ est requis'},email:{test:(value)=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),message: 'Format email invalide'},phone:{test:(value)=>/^\+?[\d\s\-\(\)]{10,}$/.test(value),message: 'Format téléphone invalide'},password:{test:(value)=> value.length >=8 &&/(?=.*[a-z])/.test(value)&&/(?=.*[A-Z])/.test(value)&&/(?=.*\d)/.test(value)&&/(?=.*[@$!%*?&])/.test(value),message: 'Mot de passe : 8+caractères,majuscule,minuscule,chiffre,caractère spécial'},minLength:(length)=>({test:(value)=> value.length >=length,message: `Minimum ${length}caractères requis`}),maxLength:(length)=>({test:(value)=> value.length <=length,message: `Maximum ${length}caractères autorisés`}),match:(targetFieldId)=>({test:(value)=>{const targetField=document.getElementById(targetFieldId);return targetField ? value===targetField.value : false;},message: 'Les mots de passe ne correspondent pas'}),pattern:(regex,message)=>({test:(value)=> regex.test(value),message: message || 'Format invalide'})};this.debounceTimeouts=new Map();this.strengthIndicators=new Map();this.notifications=[];this.init();}init(){this.createNotificationContainer();this.injectStyles();this.setupGlobalListeners();}createNotificationContainer(){if(!document.getElementById('validation-notifications')){const container=document.createElement('div');container.id='validation-notifications';container.className='validation-notifications-container';container.setAttribute('aria-live','polite');container.setAttribute('aria-atomic','true');document.body.appendChild(container);}}injectStyles(){const styles=` <style id="validation-engine-styles"> .validation-field{position: relative;margin-bottom: 1.5rem;}.validation-input{transition: all 0.3s ease;border: 2px solid rgba(255,255,255,0.3);}.validation-input:focus{outline: none;border-color: #f6ad55;box-shadow: 0 0 0 3px rgba(246,173,85,0.1);}.validation-input.valid{border-color: #10b981;background-image: url("data:image/svg+xml,%3csvg xmlns='http: background-repeat: no-repeat;background-position: right 0.75rem center;background-size: 1rem;}.validation-input.invalid{border-color: #ef4444;background-image: url("data:image/svg+xml,%3csvg xmlns='http: background-repeat: no-repeat;background-position: right 0.75rem center;background-size: 1rem;}.validation-message{position: absolute;top: 100%;left: 0;right: 0;padding: 0.5rem 0;font-size: 0.875rem;font-weight: 500;opacity: 0;transform: translateY(-10px);transition: all 0.3s ease;pointer-events: none;}.validation-message.show{opacity: 1;transform: translateY(0);}.validation-message.error{color: #ef4444;}.validation-message.success{color: #10b981;}.validation-message.warning{color: #f59e0b;}.password-strength{margin-top: 0.5rem;padding: 0.75rem;background: rgba(255,255,255,0.1);border-radius: 8px;backdrop-filter: blur(10px);}.strength-bar{height: 4px;background: rgba(255,255,255,0.2);border-radius: 2px;overflow: hidden;margin-bottom: 0.5rem;}.strength-fill{height: 100%;transition: all 0.3s ease;border-radius: 2px;}.strength-weak{background: linear-gradient(90deg,#ef4444,#f97316);width: 25%;}.strength-fair{background: linear-gradient(90deg,#f59e0b,#eab308);width: 50%;}.strength-good{background: linear-gradient(90deg,#3b82f6,#8b5cf6);width: 75%;}.strength-strong{background: linear-gradient(90deg,#10b981,#059669);width: 100%;}.strength-text{font-size: 0.8rem;color: rgba(255,255,255,0.9);text-align: center;}.validation-notifications-container{position: fixed;top: 20px;right: 20px;z-index: 1000;pointer-events: none;}.validation-notification{background: rgba(255,255,255,0.95);backdrop-filter: blur(10px);border: 1px solid rgba(255,255,255,0.2);border-radius: 12px;padding: 1rem 1.5rem;margin-bottom: 0.5rem;box-shadow: 0 8px 32px rgba(0,0,0,0.1);transform: translateX(100%);opacity: 0;transition: all 0.3s ease;pointer-events: auto;max-width: 300px;}.validation-notification.show{transform: translateX(0);opacity: 1;}.validation-notification.success{border-left: 4px solid #10b981;color: #065f46;}.validation-notification.error{border-left: 4px solid #ef4444;color: #991b1b;}.validation-notification.warning{border-left: 4px solid #f59e0b;color: #92400e;}.validation-indicator{position: absolute;right: 0.75rem;top: 50%;transform: translateY(-50%);opacity: 0;transition: all 0.3s ease;}.validation-indicator.show{opacity: 1;}.validation-indicator.loading{width: 1rem;height: 1rem;border: 2px solid rgba(255,255,255,0.3);border-top: 2px solid #f6ad55;border-radius: 50%;animation: spin 1s linear infinite;}@keyframes spin{0%{transform: translateY(-50%)rotate(0deg);}100%{transform: translateY(-50%)rotate(360deg);}}.validation-input:focus+.validation-indicator{opacity: 0;}.validation-suggestions{margin-top: 0.5rem;padding: 0.5rem;background: rgba(59,130,246,0.1);border-radius: 6px;border-left: 3px solid #3b82f6;}.validation-suggestions ul{list-style: none;padding: 0;margin: 0;font-size: 0.8rem;color: rgba(255,255,255,0.8);}.validation-suggestions li{padding: 0.2rem 0;position: relative;padding-left: 1.5rem;}.validation-suggestions li:before{content: "•";position: absolute;left: 0.5rem;color: #3b82f6;}.validation-suggestions li.completed:before{content: "✓";color: #10b981;}</style> `;if(!document.getElementById('validation-engine-styles')){document.head.insertAdjacentHTML('beforeend',styles);}}setupGlobalListeners(){document.addEventListener('input',(e)=>{if(e.target.matches('[data-validate]')){this.validateField(e.target);}});document.addEventListener('focus',(e)=>{if(e.target.matches('[data-validate]')){this.onFieldFocus(e.target);}},true);document.addEventListener('blur',(e)=>{if(e.target.matches('[data-validate]')){this.onFieldBlur(e.target);}},true);document.addEventListener('submit',(e)=>{if(e.target.matches('[data-validate-form]')){this.validateForm(e.target,e);}});}registerField(fieldId,rules,options={}){const field=document.getElementById(fieldId);if(!field){console.error(`Field with id '${fieldId}' not found`);return;}field.setAttribute('data-validate','true');this.wrapField(field,options);this.fields.set(fieldId,{element: field,rules: rules,options: options,isValid: false,lastValue: '',showSuggestions: options.showSuggestions || false});if(options.type==='password' && options.showStrength){this.setupPasswordStrength(field);}}wrapField(field,options){if(field.parentElement.classList.contains('validation-field')){return;}const wrapper=document.createElement('div');wrapper.className='validation-field';field.parentNode.insertBefore(wrapper,field);wrapper.appendChild(field);field.classList.add('validation-input');const indicator=document.createElement('div');indicator.className='validation-indicator';wrapper.appendChild(indicator);const messageContainer=document.createElement('div');messageContainer.className='validation-message';messageContainer.id=`${field.id}-message`;messageContainer.setAttribute('aria-live','polite');messageContainer.setAttribute('role','alert');wrapper.appendChild(messageContainer);if(options.showSuggestions){const suggestionsContainer=document.createElement('div');suggestionsContainer.className='validation-suggestions';suggestionsContainer.id=`${field.id}-suggestions`;suggestionsContainer.style.display='none';wrapper.appendChild(suggestionsContainer);}field.setAttribute('aria-describedby',`${field.id}-message`);}validateField(field){const fieldId=field.id;const fieldData=this.fields.get(fieldId);if(!fieldData)return;if(this.debounceTimeouts.has(fieldId)){clearTimeout(this.debounceTimeouts.get(fieldId));}this.debounceTimeouts.set(fieldId,setTimeout(()=>{this.performValidation(fieldId);},300));}performValidation(fieldId){const fieldData=this.fields.get(fieldId);if(!fieldData)return;const{element,rules,options}=fieldData;const value=element.value;this.showLoadingIndicator(element);const validationResult=this.validateValue(value,rules);fieldData.isValid=validationResult.isValid;fieldData.lastValue=value;setTimeout(()=>{this.updateFieldUI(element,validationResult);if(options.type==='password' && options.showStrength){this.updatePasswordStrength(element,value);}if(options.showSuggestions){this.updateSuggestions(element,value,validationResult);}},200);}validateValue(value,rules){const errors=[];const warnings=[];for(const rule of rules){let ruleObj;if(typeof rule==='string'){ruleObj=this.rules[rule];}else if(typeof rule==='object'){ruleObj=rule;}else if(typeof rule==='function'){ruleObj=rule();}if(ruleObj && !ruleObj.test(value)){if(ruleObj.severity==='warning'){warnings.push(ruleObj.message);}else{errors.push(ruleObj.message);}}}return{isValid: errors.length===0,errors: errors,warnings: warnings,hasWarnings: warnings.length > 0};}updateFieldUI(field,validationResult){const{isValid,errors,warnings}=validationResult;field.classList.remove('valid','invalid');field.classList.add(isValid ? 'valid' : 'invalid');field.setAttribute('aria-invalid',!isValid);const messageContainer=document.getElementById(`${field.id}-message`);if(messageContainer){// PROTECTION: Utiliser insertAdjacentHTML au lieu de innerHTML
    messageContainer.innerHTML = '';messageContainer.classList.remove('show','error','success','warning');if(errors.length > 0){messageContainer.textContent=errors[0];messageContainer.classList.add('show','error');}else if(warnings.length > 0){messageContainer.textContent=warnings[0];messageContainer.classList.add('show','warning');}else if(field.value.trim()){messageContainer.textContent='Valide ✓';messageContainer.classList.add('show','success');}}this.hideLoadingIndicator(field);}setupPasswordStrength(field){const wrapper=field.closest('.validation-field');if(!wrapper)return;const strengthContainer=document.createElement('div');strengthContainer.className='password-strength';// PROTECTION: Utiliser insertAdjacentHTML au lieu de innerHTML
    strengthContainer.innerHTML = ` <div class="strength-bar"> <div class="strength-fill"></div> </div> <div class="strength-text">Tapez votre mot de passe</div> `;wrapper.appendChild(strengthContainer);this.strengthIndicators.set(field.id,{container: strengthContainer,bar: strengthContainer.querySelector('.strength-fill'),text: strengthContainer.querySelector('.strength-text')});}updatePasswordStrength(field,password){const indicator=this.strengthIndicators.get(field.id);if(!indicator)return;const strength=this.calculatePasswordStrength(password);indicator.bar.className=`strength-fill strength-${strength.level}`;indicator.text.textContent=strength.text;indicator.container.setAttribute('aria-label',`Force du mot de passe : ${strength.text}`);}calculatePasswordStrength(password){let score=0;let feedback=[];if(password.length >=8)score+=1;else feedback.push('8 caractères minimum');if(/[a-z]/.test(password))score+=1;else feedback.push('minuscules');if(/[A-Z]/.test(password))score+=1;else feedback.push('majuscules');if(/\d/.test(password))score+=1;else feedback.push('chiffres');if(/[@$!%*?&]/.test(password))score+=1;else feedback.push('caractères spéciaux');const levels={0:{level: 'weak',text: 'Très faible'},1:{level: 'weak',text: 'Faible'},2:{level: 'fair',text: 'Moyen'},3:{level: 'good',text: 'Bon'},4:{level: 'good',text: 'Très bon'},5:{level: 'strong',text: 'Excellent'}};return levels[score] || levels[0];}updateSuggestions(field,value,validationResult){const suggestionsContainer=document.getElementById(`${field.id}-suggestions`);if(!suggestionsContainer)return;const suggestions=this.generateSuggestions(field,value,validationResult);if(suggestions.length > 0){// PROTECTION: Utiliser insertAdjacentHTML au lieu de innerHTML
    suggestionsContainer.innerHTML = ` <ul> ${suggestions.map(suggestion=> ` <li class="${suggestion.completed ? 'completed' : ''}"> ${suggestion.text}</li> `).join('')}</ul> `;suggestionsContainer.style.display='block';}else{suggestionsContainer.style.display='none';}}generateSuggestions(field,value,validationResult){const suggestions=[];const fieldData=this.fields.get(field.id);if(!fieldData || !fieldData.options.showSuggestions)return suggestions;if(fieldData.options.type==='password'){suggestions.push({text: 'Au moins 8 caractères',completed: value.length >=8},{text: 'Une majuscule',completed:/[A-Z]/.test(value)},{text: 'Une minuscule',completed:/[a-z]/.test(value)},{text: 'Un chiffre',completed:/\d/.test(value)},{text: 'Un caractère spécial',completed:/[@$!%*?&]/.test(value)});}if(fieldData.options.type==='email'){const hasAt=value.includes('@');const hasDot=value.includes('.');suggestions.push({text: 'Contient @',completed: hasAt},{text: 'Contient un domaine',completed: hasAt && hasDot},{text: 'Format valide',completed: validationResult.isValid});}return suggestions;}showLoadingIndicator(field){const indicator=field.parentElement.querySelector('.validation-indicator');if(indicator){indicator.className='validation-indicator loading show';}}hideLoadingIndicator(field){const indicator=field.parentElement.querySelector('.validation-indicator');if(indicator){indicator.className='validation-indicator';}}onFieldFocus(field){const fieldData=this.fields.get(field.id);if(fieldData && fieldData.options.showSuggestions){const suggestionsContainer=document.getElementById(`${field.id}-suggestions`);if(suggestionsContainer){suggestionsContainer.style.display='block';}}}onFieldBlur(field){this.validateField(field);}validateForm(form,event){event.preventDefault();const fields=form.querySelectorAll('[data-validate]');let isFormValid=true;const errors=[];fields.forEach(field=>{this.performValidation(field.id);const fieldData=this.fields.get(field.id);if(fieldData && !fieldData.isValid){isFormValid=false;errors.push({field: field.id,message: this.getFieldError(field.id)});}});if(isFormValid){this.showNotification('Formulaire valide ! ✓','success');form.dispatchEvent(new CustomEvent('validation:success',{detail:{form: form}}));}else{this.showNotification(`${errors.length}erreur(s)dans le formulaire`,'error');const firstErrorField=document.getElementById(errors[0].field);if(firstErrorField){firstErrorField.scrollIntoView({behavior: 'smooth',block: 'center'});firstErrorField.focus();}form.dispatchEvent(new CustomEvent('validation:error',{detail:{form: form,errors: errors}}));}return isFormValid;}getFieldError(fieldId){const messageContainer=document.getElementById(`${fieldId}-message`);return messageContainer ? messageContainer.textContent : '';}showNotification(message,type='info'){const container=document.getElementById('validation-notifications');if(!container)return;const notification=document.createElement('div');notification.className=`validation-notification ${type}`;// PROTECTION: Utiliser insertAdjacentHTML au lieu de innerHTML
    notification.innerHTML = ` <div style="display: flex;align-items: center;gap: 0.5rem;"> <i class="fas fa-${type==='success' ? 'check' : type==='error' ? 'times' : 'info'}-circle"></i> <span>${message}</span> </div> `;container.appendChild(notification);setTimeout(()=>{notification.classList.add('show');},100);setTimeout(()=>{notification.classList.remove('show');setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification);}},300);},4000);}getFieldData(fieldId){return this.fields.get(fieldId);}isFieldValid(fieldId){const fieldData=this.fields.get(fieldId);return fieldData ? fieldData.isValid : false;}isFormValid(formId){const form=document.getElementById(formId);if(!form)return false;const fields=form.querySelectorAll('[data-validate]');for(const field of fields){if(!this.isFieldValid(field.id)){return false;}}return true;}reset(fieldId){const fieldData=this.fields.get(fieldId);if(!fieldData)return;const{element}=fieldData;element.classList.remove('valid','invalid');element.setAttribute('aria-invalid','false');const messageContainer=document.getElementById(`${fieldId}-message`);if(messageContainer){// PROTECTION: Utiliser insertAdjacentHTML au lieu de innerHTML
    messageContainer.innerHTML = '';messageContainer.classList.remove('show','error','success','warning');}const suggestionsContainer=document.getElementById(`${fieldId}-suggestions`);if(suggestionsContainer){suggestionsContainer.style.display='none';}if(fieldData.options.type==='password'){this.updatePasswordStrength(element,'');}}}const ValidationEngine=new ValidationEngine();window.ValidationEngine=ValidationEngine;