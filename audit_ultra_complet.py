#!/usr/bin/env python3
"""
AUDIT ULTRA-COMPLET ET EXHAUSTIF
Analyse chaque prix, chaque villa, chaque doublon - TOUT EN D√âTAIL
"""

import os
import re
import glob
import csv
from urllib.parse import urlparse

def load_csv_reference():
    """Charge TOUTES les donn√©es CSV avec v√©rification"""
    print("üìä Chargement du CSV de r√©f√©rence...")
    
    csv_data = {}
    try:
        with open('/app/Catalogue_Villas_Khanel_Concept_Complet_Final.csv', 'r', encoding='utf-8') as f:
            reader = csv.DictReader(f)
            for i, row in enumerate(reader, 1):
                if row['Nom de la Villa']:
                    csv_data[row['Nom de la Villa']] = row
                    print(f"   {i}. CSV: {row['Nom de la Villa']}")
        
        print(f"‚úÖ {len(csv_data)} villas charg√©es depuis le CSV")
        return csv_data
    except Exception as e:
        print(f"‚ùå Erreur chargement CSV: {e}")
        return {}

def extract_all_prices_detailed(content, filename):
    """Extrait TOUS les prix avec leur contexte exact"""
    
    # Patterns tr√®s d√©taill√©s pour capturer tous les prix
    price_patterns = [
        (r'(\d+)‚Ç¨/nuit', 'par nuit'),
        (r'(\d+)‚Ç¨/jour', 'par jour'),
        (r'(\d+)‚Ç¨/semaine', 'par semaine'),
        (r'(\d+)‚Ç¨\s*\(\s*\d+\s*nuits?\)', 'weekend'),
        (r'Weekend[^:]*:\s*(\d+)‚Ç¨', 'weekend'),
        (r'Semaine[^:]*:\s*(\d+)‚Ç¨', 'semaine'),
        (r'Base[^:]*:\s*(\d+)‚Ç¨', 'base'),
        (r'Prix[^:]*:\s*(\d+)‚Ç¨', 'prix'),
        (r'Caution[^:]*:\s*(\d+)‚Ç¨', 'caution'),
        (r'(\d+)‚Ç¨\s*en esp√®ces', 'esp√®ces'),
        (r'(\d+)‚Ç¨\s*par ch√®que', 'ch√®que'),
        (r'Juillet[^:]*:\s*(\d+)‚Ç¨', 'juillet'),
        (r'Ao√ªt[^:]*:\s*(\d+)‚Ç¨', 'ao√ªt'),
        (r'No√´l[^:]*:\s*(\d+)‚Ç¨', 'no√´l'),
        (r'(\d+)‚Ç¨\s*\(\s*\d+\s*jours?\)', 's√©jour'),
        (r'>(\d+)‚Ç¨<', 'prix affich√©'),
        (r'(\d+)‚Ç¨(?!\s*\d)', 'g√©n√©ral')
    ]
    
    all_prices = []
    
    for pattern, context in price_patterns:
        matches = re.finditer(pattern, content, re.IGNORECASE)
        for match in matches:
            price = int(match.group(1))
            # Extraire le contexte environnant
            start = max(0, match.start() - 50)
            end = min(len(content), match.end() + 50)
            surrounding = content[start:end].replace('\n', ' ').strip()
            
            all_prices.append({
                'prix': price,
                'contexte': context,
                'environnement': surrounding,
                'position': match.start()
            })
    
    return all_prices

def analyze_villa_comprehensively(file_path, csv_data):
    """Analyse COMPL√àTE d'une villa - tout en d√©tail"""
    
    filename = os.path.basename(file_path)
    villa_name = filename.replace('.html', '').replace('-', ' ').title()
    
    print(f"\nüîç ANALYSE EXHAUSTIVE: {filename}")
    print("-" * 50)
    
    # V√©rifier que le fichier existe et est accessible
    if not os.path.exists(file_path):
        print(f"‚ùå FICHIER INEXISTANT: {file_path}")
        return {'errors': ['Fichier inexistant']}
    
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
    except Exception as e:
        print(f"‚ùå ERREUR LECTURE: {e}")
        return {'errors': [f'Erreur lecture: {e}']}
    
    analysis = {
        'filename': filename,
        'file_size': len(content),
        'errors': [],
        'warnings': [],
        'sections': [],
        'prices': [],
        'csv_match': None,
        'duplicates': []
    }
    
    # 1. CORRESPONDANCE CSV
    file_to_csv = {
        'villa-f3-petit-macabou.html': 'Villa F3 sur Petit Macabou',
        'villa-f3-baccha-petit-macabou.html': 'Villa F3 POUR LA BACCHA',
        'villa-f3-le-francois.html': 'Villa F3 sur le Fran√ßois',
        'villa-f5-ste-anne.html': 'Villa F5 sur Ste Anne',
        'villa-f6-lamentin.html': 'Villa F6 au Lamentin',
        'villa-f6-ste-luce-plage.html': 'Villa F6 sur Ste Luce √† 1mn de la plage',
        'villa-f3-trinite-cosmy.html': 'Villa F3 Bas de villa Trinit√© Cosmy',
        'villa-f3-robert-pointe-hyacinthe.html': 'Bas de villa F3 sur le Robert',
        'villa-f3-trenelle-location-annuelle.html': 'Appartement F3 Trenelle (Location Annuelle)',
        'villa-f5-vauclin-ravine-plate.html': 'Villa F5 Vauclin Ravine Plate',
        'villa-f5-r-pilote-la-renee.html': 'Villa F5 La Ren√©e',
        'villa-f7-baie-des-mulets-vauclin.html': 'Villa F7 Baie des Mulets',
        'villa-f6-petit-macabou.html': 'Villa F6 sur Petit Macabou (s√©jour + f√™te)',
        'villa-fete-journee-ducos.html': 'Villa F√™te Journ√©e Ducos',
        'villa-fete-journee-fort-de-france.html': 'Villa F√™te Journ√©e Fort de France',
        'villa-fete-journee-r-pilote.html': 'Villa F√™te Journ√©e Rivi√®re-Pilote',
        'villa-fete-journee-riviere-salee.html': 'Villa F√™te Journ√©e Rivi√®re Sal√©e',
        'villa-fete-journee-sainte-luce.html': 'Villa F√™te Journ√©e Sainte-Luce'
    }
    
    csv_name = file_to_csv.get(filename)
    if csv_name and csv_name in csv_data:
        analysis['csv_match'] = csv_data[csv_name]
        print(f"‚úÖ Correspondance CSV: {csv_name}")
    else:
        analysis['errors'].append(f"Aucune correspondance CSV pour {filename}")
        print(f"‚ùå AUCUNE CORRESPONDANCE CSV")
    
    # 2. ANALYSE DU TITRE
    title_match = re.search(r'<title>(.*?)</title>', content)
    if title_match:
        print(f"üìÑ Titre: {title_match.group(1)}")
    else:
        analysis['errors'].append("Titre manquant")
    
    # 3. SECTIONS D'INFORMATION
    info_sections = re.findall(r'<h[1-6][^>]*>.*?(?:Information|Tarif).*?</h[1-6]>', content, re.IGNORECASE)
    analysis['sections'] = info_sections
    print(f"üìã Sections d'information trouv√©es: {len(info_sections)}")
    
    for i, section in enumerate(info_sections, 1):
        print(f"   {i}. {section.strip()}")
        if i > 1:
            analysis['duplicates'].append(f"Section {i}: {section.strip()}")
    
    # 4. ANALYSE EXHAUSTIVE DES PRIX
    all_prices = extract_all_prices_detailed(content, filename)
    analysis['prices'] = all_prices
    
    print(f"üí∞ TOUS LES PRIX TROUV√âS ({len(all_prices)}):")
    
    # Grouper les prix par valeur
    price_groups = {}
    for price_info in all_prices:
        prix = price_info['prix']
        if prix not in price_groups:
            price_groups[prix] = []
        price_groups[prix].append(price_info)
    
    for prix, occurrences in sorted(price_groups.items()):
        print(f"   {prix}‚Ç¨ ({len(occurrences)} fois):")
        for occ in occurrences[:3]:  # Limiter √† 3 exemples
            context_short = occ['environnement'][:60] + "..." if len(occ['environnement']) > 60 else occ['environnement']
            print(f"      ‚Üí {occ['contexte']}: {context_short}")
        if len(occurrences) > 3:
            print(f"      ... et {len(occurrences) - 3} autres occurrences")
    
    # 5. D√âTECTION DES DOUBLONS DE PRIX
    duplicated_prices = {prix: occs for prix, occs in price_groups.items() if len(occs) > 1}
    if duplicated_prices:
        analysis['warnings'].append(f"{len(duplicated_prices)} prix en double")
        print(f"‚ö†Ô∏è DOUBLONS DE PRIX D√âTECT√âS:")
        for prix, occs in duplicated_prices.items():
            print(f"   {prix}‚Ç¨ r√©p√©t√© {len(occs)} fois")
    
    # 6. V√âRIFICATION CSV vs R√âALIT√â
    if analysis['csv_match']:
        csv_tarif = analysis['csv_match']['Tarif']
        csv_prices = re.findall(r'(\d+)', csv_tarif)
        csv_prices = [int(p) for p in csv_prices]
        
        found_prices = list(price_groups.keys())
        
        print(f"üìä COMPARAISON CSV:")
        print(f"   Prix CSV attendus: {csv_prices}")
        print(f"   Prix trouv√©s: {found_prices}")
        
        missing_csv_prices = [p for p in csv_prices if p not in found_prices]
        extra_prices = [p for p in found_prices if p not in csv_prices]
        
        if missing_csv_prices:
            analysis['errors'].append(f"Prix CSV manquants: {missing_csv_prices}")
            print(f"   ‚ùå Prix CSV manquants: {missing_csv_prices}")
        
        if extra_prices:
            analysis['warnings'].append(f"Prix suppl√©mentaires: {extra_prices}")
            print(f"   ‚ö†Ô∏è Prix suppl√©mentaires: {extra_prices}")
    
    # 7. R√âSUM√â DE L'ANALYSE
    print(f"\nüìä R√âSUM√â {filename}:")
    print(f"   ‚Ä¢ Taille fichier: {analysis['file_size']} caract√®res")
    print(f"   ‚Ä¢ Sections info: {len(analysis['sections'])}")
    print(f"   ‚Ä¢ Prix uniques: {len(price_groups)}")
    print(f"   ‚Ä¢ Prix doublons: {len(duplicated_prices)}")
    print(f"   ‚Ä¢ Erreurs: {len(analysis['errors'])}")
    print(f"   ‚Ä¢ Avertissements: {len(analysis['warnings'])}")
    
    return analysis

def comprehensive_audit():
    """Audit ULTRA-COMPLET de toutes les villas"""
    
    print("üöÄ AUDIT ULTRA-COMPLET ET EXHAUSTIF")
    print("=" * 80)
    print("Analyse d√©taill√©e de chaque prix, chaque villa, chaque doublon")
    print("=" * 80)
    
    # Charger les donn√©es CSV
    csv_data = load_csv_reference()
    
    # Lister tous les fichiers villa
    villa_files = glob.glob('/app/villa-*.html')
    villa_files = [f for f in villa_files if 'template' not in f and 'details' not in f]
    
    print(f"\nüè† VILLAS √Ä AUDITER ({len(villa_files)}):")
    for i, file_path in enumerate(villa_files, 1):
        print(f"   {i}. {os.path.basename(file_path)}")
    
    print("\n" + "=" * 80)
    
    # Analyser chaque villa en d√©tail
    all_analyses = []
    critical_errors = 0
    total_warnings = 0
    
    for file_path in sorted(villa_files):
        analysis = analyze_villa_comprehensively(file_path, csv_data)
        all_analyses.append(analysis)
        
        critical_errors += len(analysis.get('errors', []))
        total_warnings += len(analysis.get('warnings', []))
    
    # RAPPORT FINAL ULTRA-D√âTAILL√â
    print("\n" + "=" * 80)
    print("üìã RAPPORT FINAL ULTRA-D√âTAILL√â")
    print("=" * 80)
    
    print(f"üè† Villas audit√©es: {len(all_analyses)}")
    print(f"‚ùå Erreurs critiques: {critical_errors}")
    print(f"‚ö†Ô∏è Avertissements: {total_warnings}")
    
    # Villas avec erreurs critiques
    critical_villas = [a for a in all_analyses if a.get('errors')]
    if critical_villas:
        print(f"\nüö® VILLAS AVEC ERREURS CRITIQUES ({len(critical_villas)}):")
        for analysis in critical_villas:
            print(f"   ‚Ä¢ {analysis['filename']}:")
            for error in analysis['errors']:
                print(f"     ‚ùå {error}")
    
    # Villas avec doublons
    duplicate_villas = [a for a in all_analyses if a.get('duplicates')]
    if duplicate_villas:
        print(f"\nüîÑ VILLAS AVEC DOUBLONS ({len(duplicate_villas)}):")
        for analysis in duplicate_villas:
            print(f"   ‚Ä¢ {analysis['filename']}:")
            for duplicate in analysis['duplicates']:
                print(f"     üîÑ {duplicate}")
    
    # Villas avec prix multiples suspects
    suspicious_prices = [a for a in all_analyses if len(set(p['prix'] for p in a.get('prices', []))) > 8]
    if suspicious_prices:
        print(f"\nüí∞ VILLAS AVEC TROP DE PRIX DIFF√âRENTS ({len(suspicious_prices)}):")
        for analysis in suspicious_prices:
            prices = set(p['prix'] for p in analysis.get('prices', []))
            print(f"   ‚Ä¢ {analysis['filename']}: {len(prices)} prix diff√©rents")
            print(f"     {sorted(list(prices))}")
    
    # CONCLUSION
    print(f"\nüéØ CONCLUSION:")
    if critical_errors == 0 and total_warnings == 0:
        print("üéâ PARFAIT ! Aucun probl√®me d√©tect√©.")
    elif critical_errors == 0:
        print(f"‚úÖ ACCEPTABLE - Seulement {total_warnings} avertissements mineurs.")
    else:
        print(f"üö® ACTION REQUISE - {critical_errors} erreurs critiques √† corriger.")
    
    return all_analyses

if __name__ == "__main__":
    comprehensive_audit()