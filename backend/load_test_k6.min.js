import http from 'k6/http';import{check,sleep}from 'k6';import{Rate,Trend,Counter}from 'k6/metrics';const loginSuccessRate=new Rate('login_success_rate');const searchSuccessRate=new Rate('search_success_rate');const reservationSuccessRate=new Rate('reservation_success_rate');const responseTime=new Trend('response_time');const errorCounter=new Counter('errors');export let options={stages: [{duration: '30s',target: 20},{duration: '60s',target: 50},{duration: '120s',target: 100},{duration: '60s',target: 100},{duration: '30s',target: 0},],thresholds:{http_req_duration: ['p(95)<2000'],http_req_failed: ['rate<0.1'],login_success_rate: ['rate>0.8'],search_success_rate: ['rate>0.9'],reservation_success_rate: ['rate>0.7'],},};const BASE_URL='http: const destinations=[ 'Fort-de-France','Lamentin','Schoelcher','Vauclin','Ste-Anne','Ducos','RiviÃ¨re-SalÃ©e','Petit-Macabou' ];const categories=['sejour','fete','all'];function randomChoice(array){return array[Math.floor(Math.random()*array.length)];}function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}function generateEmail(){return `loadtest_${randomInt(1000,9999)}@test.com`;}function generateDates(){const checkin=new Date();checkin.setDate(checkin.getDate()+randomInt(7,60));const checkout=new Date(checkin);checkout.setDate(checkout.getDate()+randomInt(2,14));return{checkin: checkin.toISOString().split('T')[0],checkout: checkout.toISOString().split('T')[0]};}export default function(){const userEmail=generateEmail();let selectedVilla=null;const healthStart=Date.now();const healthResponse=http.get(`${BASE_URL}/health`);responseTime.add(Date.now()-healthStart);const healthCheck=check(healthResponse,{'Health check status is 200':(r)=> r.status===200,'Health check has status healthy':(r)=>{try{return r.json().status==='healthy';}catch(e){return false;}}});if(!healthCheck){errorCounter.add(1);console.log('âŒ Health check failed,skipping user session');return;}if(Math.random()< 0.3){const adminLoginStart=Date.now();const adminLoginResponse=http.post(`${BASE_URL}/admin/login`,JSON.stringify({username: 'admin',password: 'khanelconcept2025'}),{headers:{'Content-Type': 'application/json'},});responseTime.add(Date.now()-adminLoginStart);const adminLoginSuccess=check(adminLoginResponse,{'Admin login status is 200':(r)=> r.status===200,'Admin login has access_token':(r)=>{try{return r.json().access_token !==undefined;}catch(e){return false;}}});loginSuccessRate.add(adminLoginSuccess);if(!adminLoginSuccess){errorCounter.add(1);}}const searchStart=Date.now();const searchCriteria={destination: randomChoice(destinations),guests: randomInt(2,8),category: randomChoice(categories)};const searchResponse=http.post(`${BASE_URL}/villas/search`,JSON.stringify(searchCriteria),{headers:{'Content-Type': 'application/json'},});responseTime.add(Date.now()-searchStart);const searchSuccess=check(searchResponse,{'Villa search status is 200':(r)=> r.status===200,'Villa search returns array':(r)=>{try{return Array.isArray(r.json());}catch(e){return false;}}});searchSuccessRate.add(searchSuccess);if(searchSuccess){try{const villas=searchResponse.json();if(villas.length > 0){selectedVilla=villas[Math.floor(Math.random()*villas.length)];}}catch(e){console.log('Error parsing search results:',e);}}else{errorCounter.add(1);}if(!selectedVilla){const allVillasStart=Date.now();const allVillasResponse=http.get(`${BASE_URL}/villas`);responseTime.add(Date.now()-allVillasStart);const allVillasSuccess=check(allVillasResponse,{'Get all villas status is 200':(r)=> r.status===200,'Get all villas returns array':(r)=>{try{return Array.isArray(r.json())&& r.json().length > 0;}catch(e){return false;}}});if(allVillasSuccess){try{const villas=allVillasResponse.json();selectedVilla=villas[Math.floor(Math.random()*villas.length)];}catch(e){console.log('Error parsing all villas:',e);}}else{errorCounter.add(1);}}if(selectedVilla){const dates=generateDates();const reservationData={villa_id: selectedVilla.id ? selectedVilla.id.toString(): '1',customer_name: `LoadTest User ${randomInt(1,1000)}`,customer_email: userEmail,customer_phone: `+596${randomInt(100000000,999999999)}`,checkin_date: dates.checkin,checkout_date: dates.checkout,guests_count: randomInt(2,6),message: 'Test de charge automatisÃ©',total_price: randomInt(300,2000)};const reservationStart=Date.now();const reservationResponse=http.post(`${BASE_URL}/reservations`,JSON.stringify(reservationData),{headers:{'Content-Type': 'application/json'},});responseTime.add(Date.now()-reservationStart);const reservationSuccess=check(reservationResponse,{'Reservation status is 200':(r)=> r.status===200,'Reservation has success flag':(r)=>{try{return r.json().success===true;}catch(e){return false;}}});reservationSuccessRate.add(reservationSuccess);if(!reservationSuccess){errorCounter.add(1);console.log(`Reservation failed: ${reservationResponse.status}-${reservationResponse.body}`);}}const statsStart=Date.now();const statsResponse=http.get(`${BASE_URL}/stats/dashboard`);responseTime.add(Date.now()-statsStart);const statsSuccess=check(statsResponse,{'Dashboard stats status is 200':(r)=> r.status===200,'Dashboard stats has data':(r)=>{try{const data=r.json();return data.total_villas !==undefined && data.total_reservations !==undefined;}catch(e){return false;}}});if(!statsSuccess){errorCounter.add(1);}sleep(Math.random()*2+1);}export function setup(){console.log('ğŸš€ DÃ©marrage du test de charge KhanelConcept');console.log('ğŸ“Š Cible: 100 utilisateurs simultanÃ©s');console.log('â±ï¸ DurÃ©e: 5 minutes');console.log('ğŸ¯ URL: http: const healthCheck=http.get(`${BASE_URL}/health`);if(healthCheck.status !==200){console.log('âŒ API non accessible,arrÃªt du test');throw new Error('API health check failed');}console.log('âœ… API accessible,lancement du test...');return{};}export function teardown(data){console.log('ğŸ“ˆ Test de charge terminÃ©');console.log('ğŸ“Š Consultez les mÃ©triques ci-dessus pour les rÃ©sultats dÃ©taillÃ©s');}